# Spring
Spring

-- Table
CREATE TABLE IF NOT EXISTS tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subject VARCHAR(255) NOT NULL,
    description CLOB,
    priority VARCHAR(50),
    category VARCHAR(50),
    status VARCHAR(50) DEFAULT 'New',
    created_by VARCHAR(255) NOT NULL,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_to VARCHAR(255),
    resolved_date TIMESTAMP,
    closed_date TIMESTAMP,
    attachment BLOB
);

-- Re-usable dropdown
CREATE ALIAS IF NOT EXISTS get_dropdown_values AS $$
import java.sql.*;
@CODE
ResultSet get_dropdown_values(Connection conn, String type) throws SQLException {
    String sql = """
        SELECT value, label FROM (
            VALUES
            ('High','High'), ('Medium','Medium'), ('Low','Low')
        ) AS t(value,label) WHERE ? = 'priority'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('Bug','Bug'), ('Feature','Feature'), ('Support','Support')
        ) AS t(value,label) WHERE ? = 'category'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('engineer1@company.com','Engineer 1'),
            ('engineer2@company.com','Engineer 2')
        ) AS t(value,label) WHERE ? = 'engineer';
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, type);
    ps.setString(2, type);
    ps.setString(3, type);
    return ps.executeQuery();
}
$$;

-- INSERT ticket
CREATE ALIAS IF NOT EXISTS insert_ticket AS $$
import java.sql.*;
@CODE
long insert_ticket(Connection conn,
                  String p_subject, String p_description,
                  String p_priority, String p_category,
                  String p_created_by, byte[] p_attachment) throws SQLException {
    String sql = "INSERT INTO tickets(subject,description,priority,category,created_by,attachment) " +
                 "VALUES(?,?,?,?,?,?)";
    PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
    ps.setString(1, p_subject);
    ps.setString(2, p_description);
    ps.setString(3, p_priority);
    ps.setString(4, p_category);
    ps.setString(5, p_created_by);
    ps.setObject(6, p_attachment);
    ps.executeUpdate();
    ResultSet rs = ps.getGeneratedKeys();
    rs.next();
    return rs.getLong(1);
}
$$;

-- UPDATE ticket
CREATE ALIAS IF NOT EXISTS update_ticket AS $$
import java.sql.*;
@CODE
void update_ticket(Connection conn,
                   long p_id,
                   String p_assigned_to,
                   String p_status,
                   Timestamp p_resolved_date,
                   Timestamp p_closed_date) throws SQLException {
    String sql = """
        UPDATE tickets SET
            assigned_to = COALESCE(?, assigned_to),
            status      = COALESCE(?, status),
            resolved_date = COALESCE(?, resolved_date),
            closed_date   = COALESCE(?, closed_date)
        WHERE id = ?
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_assigned_to);
    ps.setString(2, p_status);
    ps.setTimestamp(3, p_resolved_date);
    ps.setTimestamp(4, p_closed_date);
    ps.setLong(5, p_id);
    ps.executeUpdate();
}
$$;

-- Recent tickets (last 7 days)
CREATE ALIAS IF NOT EXISTS get_recent_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_recent_tickets(Connection conn) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_date >= CURRENT_DATE - INTERVAL '7' DAY ORDER BY created_date DESC";
    return conn.createStatement().executeQuery(sql);
}
$$;

-- My tickets
CREATE ALIAS IF NOT EXISTS get_user_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_user_tickets(Connection conn, String p_created_by) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_by = ? ORDER BY created_date DESC";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_created_by);
    return ps.executeQuery();
}
$$;

-- Ticket by id
CREATE ALIAS IF NOT EXISTS get_ticket_by_id AS $$
import java.sql.*;
@CODE
ResultSet get_ticket_by_id(Connection conn, long p_id) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE id = ?";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setLong(1, p_id);
    return ps.executeQuery();
}
$$;

-- Filtered tickets for reports
CREATE ALIAS IF NOT EXISTS get_filtered_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_filtered_tickets(Connection conn,
                               Date p_start, Date p_end,
                               String p_status, String p_priority) throws SQLException {
    String sql = """
        SELECT * FROM tickets
        WHERE (CAST(created_date AS DATE) BETWEEN ? AND ? OR (? IS NULL AND ? IS NULL))
          AND (status = ? OR ? IS NULL)
          AND (priority = ? OR ? IS NULL)
        ORDER BY created_date DESC
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setDate(1, p_start);
    ps.setDate(2, p_end);
    ps.setDate(3, p_start);
    ps.setDate(4, p_end);
    ps.setString(5, p_status);
    ps.setString(6, p_status);
    ps.setString(7, p_priority);
    ps.setString(8, p_priority);
    return ps.executeQuery();
}
$$;



package com.example.productsupport.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SimpleSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/h2-console/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/home", true)
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login")
                .permitAll()
            )
            .csrf(csrf -> csrf
                .ignoringRequestMatchers("/h2-console/**")
            )
            .headers(headers -> headers
                .frameOptions().sameOrigin()
            );
        return http.build();
    }

    @Bean
    public UserDetailsService users() {
        UserDetails user = User.withUsername("user")
                .password("{noop}user")
                .roles("USER")
                .build();

        UserDetails admin = User.withUsername("admin")
                .password("{noop}admin")
                .roles("ADMIN")
                .build();

        return new InMemoryUserDetailsManager(user, admin);
    }
}







package com.example.productsupport.controller;

import com.example.productsupport.dto.TicketDTO;
import com.example.productsupport.service.TicketService;
import jakarta.servlet.http.HttpSession;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.http.*;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;

@Controller
public class TicketController {

    private final TicketService service;
    private final HttpSession session;

    public TicketController(TicketService service, HttpSession session) {
        this.service = service;
        this.session = session;
    }

    private void pushAlert(Model m) {
        String a = (String) session.getAttribute("alert");
        if (a != null) {
            m.addAttribute("alert", a);
            session.removeAttribute("alert");
        }
    }

    @GetMapping({"/", "/home"})
    public String home(Model m) {
        m.addAttribute("tickets", service.recent());
        m.addAttribute("isAdmin", service.isAdmin());
        pushAlert(m);
        return "home";
    }

    @GetMapping("/menu")
    public String menu(Model m) {
        m.addAttribute("ticket", new TicketDTO());
        m.addAttribute("priorities", service.dropdown("priority"));
        m.addAttribute("categories", service.dropdown("category"));
        m.addAttribute("myTickets", service.myTickets());
        pushAlert(m);
        return "menu";
    }

    @PostMapping("/submitTicket")
    public String submit(@ModelAttribute TicketDTO t,
                         @RequestParam(required = false) MultipartFile attachment) throws IOException {
        service.create(t, attachment);
        return "redirect:/menu";
    }

    @GetMapping("/reports")
    public String reports(Model m) {
        m.addAttribute("statuses", List.of("New","Assigned","In-Progress","Resolved","Closed"));
        m.addAttribute("priorities", service.dropdown("priority"));
        pushAlert(m);
        return "reports";
    }

    @PostMapping("/filterReports")
    public String filter(@RequestParam(required = false) String startDate,
                         @RequestParam(required = false) String endDate,
                         @RequestParam(required = false) String status,
                         @RequestParam(required = false) String priority,
                         Model m) {
        m.addAttribute("tickets", service.filtered(startDate, endDate, status, priority));
        m.addAttribute("statuses", List.of("New","Assigned","In-Progress","Resolved","Closed"));
        m.addAttribute("priorities", service.dropdown("priority"));
        pushAlert(m);
        return "reports";
    }

    @GetMapping("/exportReports")
    public ResponseEntity<byte[]> export(@RequestParam(required = false) String startDate,
                                         @RequestParam(required = false) String endDate,
                                         @RequestParam(required = false) String status,
                                         @RequestParam(required = false) String priority) throws IOException {
        List<TicketDTO> list = service.filtered(startDate, endDate, status, priority);
        Workbook wb = new XSSFWorkbook();
        Sheet sh = wb.createSheet("Tickets");
        Row hdr = sh.createRow(0);
        hdr.createCell(0).setCellValue("ID");
        hdr.createCell(1).setCellValue("Subject");
        hdr.createCell(2).setCellValue("Status");
        hdr.createCell(3).setCellValue("Priority");
        hdr.createCell(4).setCellValue("Created By");

        int r = 1;
        for (TicketDTO t : list) {
            Row row = sh.createRow(r++);
            row.createCell(0).setCellValue(t.getId());
            row.createCell(1).setCellValue(t.getSubject());
            row.createCell(2).setCellValue(t.getStatus());
            row.createCell(3).setCellValue(t.getPriority());
            row.createCell(4).setCellValue(t.getCreatedBy());
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        wb.write(out);
        wb.close();

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=tickets.xlsx")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(out.toByteArray());
    }

    @GetMapping("/ticket/{id}")
    public String form(@PathVariable Long id, Model m) {
        if (!service.isAdmin()) return "redirect:/home";
        TicketDTO t = service.byId(id);
        m.addAttribute("ticket", t);
        m.addAttribute("engineers", service.dropdown("engineer"));
        m.addAttribute("statuses", List.of("Assigned","In-Progress","Resolved","Closed"));
        pushAlert(m);
        return "ticketForm";
    }

    @PostMapping("/updateTicket")
    public String update(@ModelAttribute TicketDTO t) {
        if (service.isAdmin()) service.update(t);
        return "redirect:/home";
    }
}







package com.example.productsupport.dto;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class TicketDTO {
    private Long id;
    private String subject;
    private String description;
    private String priority;
    private String category;
    private String status;
    private String createdBy;
    private LocalDateTime createdDate;
    private String assignedTo;
    private LocalDateTime resolvedDate;
    private LocalDateTime closedDate;
    private byte[] attachment;
}





package com.example.productsupport.repository;

import com.example.productsupport.dto.TicketDTO;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.stereotype.Repository;

import java.sql.Date;
import java.util.List;
import java.util.Map;

@Repository
public class TicketRepository {

    private final JdbcTemplate jdbc;

    public TicketRepository(JdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    /* ---------- Dropdown ---------- */
    public List<Map<String, Object>> getDropdown(String type) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("get_dropdown_values")
                .returningResultSet("result",
                        BeanPropertyRowMapper.newInstance(Map.class));
        return call.executeFunction(List.class,
                new MapSqlParameterSource().addValue("type", type));
    }

    /* ---------- Insert ---------- */
    public Long insertTicket(TicketDTO t) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("insert_ticket");
        MapSqlParameterSource p = new MapSqlParameterSource()
                .addValue("p_subject", t.getSubject())
                .addValue("p_description", t.getDescription())
                .addValue("p_priority", t.getPriority())
                .addValue("p_category", t.getCategory())
                .addValue("p_created_by", t.getCreatedBy())
                .addValue("p_attachment", t.getAttachment());
        return call.executeFunction(Long.class, p);
    }

    /* ---------- Update ---------- */
    public void updateTicket(TicketDTO t) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("update_ticket");
        MapSqlParameterSource p = new MapSqlParameterSource()
                .addValue("p_id", t.getId())
                .addValue("p_assigned_to", t.getAssignedTo())
                .addValue("p_status", t.getStatus())
                .addValue("p_resolved_date", t.getResolvedDate() != null ?
                        java.sql.Timestamp.valueOf(t.getResolvedDate()) : null)
                .addValue("p_closed_date", t.getClosedDate() != null ?
                        java.sql.Timestamp.valueOf(t.getClosedDate()) : null);
        call.execute(p);
    }

    /* ---------- Queries ---------- */
    public List<TicketDTO> recent() {
        return jdbc.query("SELECT * FROM get_recent_tickets()", 
                BeanPropertyRowMapper.newInstance(TicketDTO.class));
    }
    public List<TicketDTO> myTickets(String user) {
        return jdbc.query("SELECT * FROM get_user_tickets(?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class), user);
    }
    public TicketDTO byId(Long id) {
        return jdbc.query("SELECT * FROM get_ticket_by_id(?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class), id)
                .stream().findFirst().orElse(null);
    }
    public List<TicketDTO> filtered(String start, String end,
                                   String status, String priority) {
        return jdbc.query("SELECT * FROM get_filtered_tickets(?,?,?,?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class),
                start == null ? null : Date.valueOf(start),
                end   == null ? null : Date.valueOf(end),
                status, priority);
    }
}
