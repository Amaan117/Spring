# Spring
Spring

-- Table
CREATE TABLE IF NOT EXISTS tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subject VARCHAR(255) NOT NULL,
    description CLOB,
    priority VARCHAR(50),
    category VARCHAR(50),
    status VARCHAR(50) DEFAULT 'New',
    created_by VARCHAR(255) NOT NULL,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_to VARCHAR(255),
    resolved_date TIMESTAMP,
    closed_date TIMESTAMP,
    attachment BLOB
);

-- Re-usable dropdown
CREATE ALIAS IF NOT EXISTS get_dropdown_values AS $$
import java.sql.*;
@CODE
ResultSet get_dropdown_values(Connection conn, String type) throws SQLException {
    String sql = """
        SELECT value, label FROM (
            VALUES
            ('High','High'), ('Medium','Medium'), ('Low','Low')
        ) AS t(value,label) WHERE ? = 'priority'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('Bug','Bug'), ('Feature','Feature'), ('Support','Support')
        ) AS t(value,label) WHERE ? = 'category'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('engineer1@company.com','Engineer 1'),
            ('engineer2@company.com','Engineer 2')
        ) AS t(value,label) WHERE ? = 'engineer';
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, type);
    ps.setString(2, type);
    ps.setString(3, type);
    return ps.executeQuery();
}
$$;

-- INSERT ticket
CREATE ALIAS IF NOT EXISTS insert_ticket AS $$
import java.sql.*;
@CODE
long insert_ticket(Connection conn,
                  String p_subject, String p_description,
                  String p_priority, String p_category,
                  String p_created_by, byte[] p_attachment) throws SQLException {
    String sql = "INSERT INTO tickets(subject,description,priority,category,created_by,attachment) " +
                 "VALUES(?,?,?,?,?,?)";
    PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
    ps.setString(1, p_subject);
    ps.setString(2, p_description);
    ps.setString(3, p_priority);
    ps.setString(4, p_category);
    ps.setString(5, p_created_by);
    ps.setObject(6, p_attachment);
    ps.executeUpdate();
    ResultSet rs = ps.getGeneratedKeys();
    rs.next();
    return rs.getLong(1);
}
$$;

-- UPDATE ticket
CREATE ALIAS IF NOT EXISTS update_ticket AS $$
import java.sql.*;
@CODE
void update_ticket(Connection conn,
                   long p_id,
                   String p_assigned_to,
                   String p_status,
                   Timestamp p_resolved_date,
                   Timestamp p_closed_date) throws SQLException {
    String sql = """
        UPDATE tickets SET
            assigned_to = COALESCE(?, assigned_to),
            status      = COALESCE(?, status),
            resolved_date = COALESCE(?, resolved_date),
            closed_date   = COALESCE(?, closed_date)
        WHERE id = ?
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_assigned_to);
    ps.setString(2, p_status);
    ps.setTimestamp(3, p_resolved_date);
    ps.setTimestamp(4, p_closed_date);
    ps.setLong(5, p_id);
    ps.executeUpdate();
}
$$;

-- Recent tickets (last 7 days)
CREATE ALIAS IF NOT EXISTS get_recent_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_recent_tickets(Connection conn) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_date >= CURRENT_DATE - INTERVAL '7' DAY ORDER BY created_date DESC";
    return conn.createStatement().executeQuery(sql);
}
$$;

-- My tickets
CREATE ALIAS IF NOT EXISTS get_user_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_user_tickets(Connection conn, String p_created_by) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_by = ? ORDER BY created_date DESC";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_created_by);
    return ps.executeQuery();
}
$$;

-- Ticket by id
CREATE ALIAS IF NOT EXISTS get_ticket_by_id AS $$
import java.sql.*;
@CODE
ResultSet get_ticket_by_id(Connection conn, long p_id) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE id = ?";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setLong(1, p_id);
    return ps.executeQuery();
}
$$;

-- Filtered tickets for reports
CREATE ALIAS IF NOT EXISTS get_filtered_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_filtered_tickets(Connection conn,
                               Date p_start, Date p_end,
                               String p_status, String p_priority) throws SQLException {
    String sql = """
        SELECT * FROM tickets
        WHERE (CAST(created_date AS DATE) BETWEEN ? AND ? OR (? IS NULL AND ? IS NULL))
          AND (status = ? OR ? IS NULL)
          AND (priority = ? OR ? IS NULL)
        ORDER BY created_date DESC
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setDate(1, p_start);
    ps.setDate(2, p_end);
    ps.setDate(3, p_start);
    ps.setDate(4, p_end);
    ps.setString(5, p_status);
    ps.setString(6, p_status);
    ps.setString(7, p_priority);
    ps.setString(8, p_priority);
    return ps.executeQuery();
}
$$;

