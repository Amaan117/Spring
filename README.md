



# Spring
Spring

-- Table
CREATE TABLE IF NOT EXISTS tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subject VARCHAR(255) NOT NULL,
    description CLOB,
    priority VARCHAR(50),
    category VARCHAR(50),
    status VARCHAR(50) DEFAULT 'New',
    created_by VARCHAR(255) NOT NULL,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_to VARCHAR(255),
    resolved_date TIMESTAMP,
    closed_date TIMESTAMP,
    attachment BLOB
);

-- Re-usable dropdown
CREATE ALIAS IF NOT EXISTS get_dropdown_values AS $$
import java.sql.*;
@CODE
ResultSet get_dropdown_values(Connection conn, String type) throws SQLException {
    String sql = """
        SELECT value, label FROM (
            VALUES
            ('High','High'), ('Medium','Medium'), ('Low','Low')
        ) AS t(value,label) WHERE ? = 'priority'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('Bug','Bug'), ('Feature','Feature'), ('Support','Support')
        ) AS t(value,label) WHERE ? = 'category'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('engineer1@company.com','Engineer 1'),
            ('engineer2@company.com','Engineer 2')
        ) AS t(value,label) WHERE ? = 'engineer';
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, type);
    ps.setString(2, type);
    ps.setString(3, type);
    return ps.executeQuery();
}
$$;

-- INSERT ticket
CREATE ALIAS IF NOT EXISTS insert_ticket AS $$
import java.sql.*;
@CODE
long insert_ticket(Connection conn,
                  String p_subject, String p_description,
                  String p_priority, String p_category,
                  String p_created_by, byte[] p_attachment) throws SQLException {
    String sql = "INSERT INTO tickets(subject,description,priority,category,created_by,attachment) " +
                 "VALUES(?,?,?,?,?,?)";
    PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
    ps.setString(1, p_subject);
    ps.setString(2, p_description);
    ps.setString(3, p_priority);
    ps.setString(4, p_category);
    ps.setString(5, p_created_by);
    ps.setObject(6, p_attachment);
    ps.executeUpdate();
    ResultSet rs = ps.getGeneratedKeys();
    rs.next();
    return rs.getLong(1);
}
$$;

-- UPDATE ticket
CREATE ALIAS IF NOT EXISTS update_ticket AS $$
import java.sql.*;
@CODE
void update_ticket(Connection conn,
                   long p_id,
                   String p_assigned_to,
                   String p_status,
                   Timestamp p_resolved_date,
                   Timestamp p_closed_date) throws SQLException {
    String sql = """
        UPDATE tickets SET
            assigned_to = COALESCE(?, assigned_to),
            status      = COALESCE(?, status),
            resolved_date = COALESCE(?, resolved_date),
            closed_date   = COALESCE(?, closed_date)
        WHERE id = ?
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_assigned_to);
    ps.setString(2, p_status);
    ps.setTimestamp(3, p_resolved_date);
    ps.setTimestamp(4, p_closed_date);
    ps.setLong(5, p_id);
    ps.executeUpdate();
}
$$;

-- Recent tickets (last 7 days)
CREATE ALIAS IF NOT EXISTS get_recent_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_recent_tickets(Connection conn) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_date >= CURRENT_DATE - INTERVAL '7' DAY ORDER BY created_date DESC";
    return conn.createStatement().executeQuery(sql);
}
$$;

-- My tickets
CREATE ALIAS IF NOT EXISTS get_user_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_user_tickets(Connection conn, String p_created_by) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_by = ? ORDER BY created_date DESC";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_created_by);
    return ps.executeQuery();
}
$$;

-- Ticket by id
CREATE ALIAS IF NOT EXISTS get_ticket_by_id AS $$
import java.sql.*;
@CODE
ResultSet get_ticket_by_id(Connection conn, long p_id) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE id = ?";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setLong(1, p_id);
    return ps.executeQuery();
}
$$;

-- Filtered tickets for reports
CREATE ALIAS IF NOT EXISTS get_filtered_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_filtered_tickets(Connection conn,
                               Date p_start, Date p_end,
                               String p_status, String p_priority) throws SQLException {
    String sql = """
        SELECT * FROM tickets
        WHERE (CAST(created_date AS DATE) BETWEEN ? AND ? OR (? IS NULL AND ? IS NULL))
          AND (status = ? OR ? IS NULL)
          AND (priority = ? OR ? IS NULL)
        ORDER BY created_date DESC
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setDate(1, p_start);
    ps.setDate(2, p_end);
    ps.setDate(3, p_start);
    ps.setDate(4, p_end);
    ps.setString(5, p_status);
    ps.setString(6, p_status);
    ps.setString(7, p_priority);
    ps.setString(8, p_priority);
    return ps.executeQuery();
}
$$;



package com.example.productsupport.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SimpleSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/h2-console/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/home", true)
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login")
                .permitAll()
            )
            .csrf(csrf -> csrf
                .ignoringRequestMatchers("/h2-console/**")
            )
            .headers(headers -> headers
                .frameOptions().sameOrigin()
            );
        return http.build();
    }

    @Bean
    public UserDetailsService users() {
        UserDetails user = User.withUsername("user")
                .password("{noop}user")
                .roles("USER")
                .build();

        UserDetails admin = User.withUsername("admin")
                .password("{noop}admin")
                .roles("ADMIN")
                .build();

        return new InMemoryUserDetailsManager(user, admin);
    }
}







package com.example.productsupport.controller;

import com.example.productsupport.dto.TicketDTO;
import com.example.productsupport.service.TicketService;
import jakarta.servlet.http.HttpSession;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.http.*;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;

@Controller
public class TicketController {

    private final TicketService service;
    private final HttpSession session;

    public TicketController(TicketService service, HttpSession session) {
        this.service = service;
        this.session = session;
    }

    private void pushAlert(Model m) {
        String a = (String) session.getAttribute("alert");
        if (a != null) {
            m.addAttribute("alert", a);
            session.removeAttribute("alert");
        }
    }

    @GetMapping({"/", "/home"})
    public String home(Model m) {
        m.addAttribute("tickets", service.recent());
        m.addAttribute("isAdmin", service.isAdmin());
        pushAlert(m);
        return "home";
    }

    @GetMapping("/menu")
    public String menu(Model m) {
        m.addAttribute("ticket", new TicketDTO());
        m.addAttribute("priorities", service.dropdown("priority"));
        m.addAttribute("categories", service.dropdown("category"));
        m.addAttribute("myTickets", service.myTickets());
        pushAlert(m);
        return "menu";
    }

    @PostMapping("/submitTicket")
    public String submit(@ModelAttribute TicketDTO t,
                         @RequestParam(required = false) MultipartFile attachment) throws IOException {
        service.create(t, attachment);
        return "redirect:/menu";
    }

    @GetMapping("/reports")
    public String reports(Model m) {
        m.addAttribute("statuses", List.of("New","Assigned","In-Progress","Resolved","Closed"));
        m.addAttribute("priorities", service.dropdown("priority"));
        pushAlert(m);
        return "reports";
    }

    @PostMapping("/filterReports")
    public String filter(@RequestParam(required = false) String startDate,
                         @RequestParam(required = false) String endDate,
                         @RequestParam(required = false) String status,
                         @RequestParam(required = false) String priority,
                         Model m) {
        m.addAttribute("tickets", service.filtered(startDate, endDate, status, priority));
        m.addAttribute("statuses", List.of("New","Assigned","In-Progress","Resolved","Closed"));
        m.addAttribute("priorities", service.dropdown("priority"));
        pushAlert(m);
        return "reports";
    }

    @GetMapping("/exportReports")
    public ResponseEntity<byte[]> export(@RequestParam(required = false) String startDate,
                                         @RequestParam(required = false) String endDate,
                                         @RequestParam(required = false) String status,
                                         @RequestParam(required = false) String priority) throws IOException {
        List<TicketDTO> list = service.filtered(startDate, endDate, status, priority);
        Workbook wb = new XSSFWorkbook();
        Sheet sh = wb.createSheet("Tickets");
        Row hdr = sh.createRow(0);
        hdr.createCell(0).setCellValue("ID");
        hdr.createCell(1).setCellValue("Subject");
        hdr.createCell(2).setCellValue("Status");
        hdr.createCell(3).setCellValue("Priority");
        hdr.createCell(4).setCellValue("Created By");

        int r = 1;
        for (TicketDTO t : list) {
            Row row = sh.createRow(r++);
            row.createCell(0).setCellValue(t.getId());
            row.createCell(1).setCellValue(t.getSubject());
            row.createCell(2).setCellValue(t.getStatus());
            row.createCell(3).setCellValue(t.getPriority());
            row.createCell(4).setCellValue(t.getCreatedBy());
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        wb.write(out);
        wb.close();

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=tickets.xlsx")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(out.toByteArray());
    }

    @GetMapping("/ticket/{id}")
    public String form(@PathVariable Long id, Model m) {
        if (!service.isAdmin()) return "redirect:/home";
        TicketDTO t = service.byId(id);
        m.addAttribute("ticket", t);
        m.addAttribute("engineers", service.dropdown("engineer"));
        m.addAttribute("statuses", List.of("Assigned","In-Progress","Resolved","Closed"));
        pushAlert(m);
        return "ticketForm";
    }

    @PostMapping("/updateTicket")
    public String update(@ModelAttribute TicketDTO t) {
        if (service.isAdmin()) service.update(t);
        return "redirect:/home";
    }
}







package com.example.productsupport.dto;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class TicketDTO {
    private Long id;
    private String subject;
    private String description;
    private String priority;
    private String category;
    private String status;
    private String createdBy;
    private LocalDateTime createdDate;
    private String assignedTo;
    private LocalDateTime resolvedDate;
    private LocalDateTime closedDate;
    private byte[] attachment;
}





package com.example.productsupport.repository;

import com.example.productsupport.dto.TicketDTO;
import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.stereotype.Repository;

import java.sql.Date;
import java.util.List;
import java.util.Map;

@Repository
public class TicketRepository {

    private final JdbcTemplate jdbc;

    public TicketRepository(JdbcTemplate jdbc) {
        this.jdbc = jdbc;
    }

    /* ---------- Dropdown ---------- */
    public List<Map<String, Object>> getDropdown(String type) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("get_dropdown_values")
                .returningResultSet("result",
                        BeanPropertyRowMapper.newInstance(Map.class));
        return call.executeFunction(List.class,
                new MapSqlParameterSource().addValue("type", type));
    }

    /* ---------- Insert ---------- */
    public Long insertTicket(TicketDTO t) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("insert_ticket");
        MapSqlParameterSource p = new MapSqlParameterSource()
                .addValue("p_subject", t.getSubject())
                .addValue("p_description", t.getDescription())
                .addValue("p_priority", t.getPriority())
                .addValue("p_category", t.getCategory())
                .addValue("p_created_by", t.getCreatedBy())
                .addValue("p_attachment", t.getAttachment());
        return call.executeFunction(Long.class, p);
    }

    /* ---------- Update ---------- */
    public void updateTicket(TicketDTO t) {
        SimpleJdbcCall call = new SimpleJdbcCall(jdbc)
                .withFunctionName("update_ticket");
        MapSqlParameterSource p = new MapSqlParameterSource()
                .addValue("p_id", t.getId())
                .addValue("p_assigned_to", t.getAssignedTo())
                .addValue("p_status", t.getStatus())
                .addValue("p_resolved_date", t.getResolvedDate() != null ?
                        java.sql.Timestamp.valueOf(t.getResolvedDate()) : null)
                .addValue("p_closed_date", t.getClosedDate() != null ?
                        java.sql.Timestamp.valueOf(t.getClosedDate()) : null);
        call.execute(p);
    }

    /* ---------- Queries ---------- */
    public List<TicketDTO> recent() {
        return jdbc.query("SELECT * FROM get_recent_tickets()", 
                BeanPropertyRowMapper.newInstance(TicketDTO.class));
    }
    public List<TicketDTO> myTickets(String user) {
        return jdbc.query("SELECT * FROM get_user_tickets(?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class), user);
    }
    public TicketDTO byId(Long id) {
        return jdbc.query("SELECT * FROM get_ticket_by_id(?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class), id)
                .stream().findFirst().orElse(null);
    }
    public List<TicketDTO> filtered(String start, String end,
                                   String status, String priority) {
        return jdbc.query("SELECT * FROM get_filtered_tickets(?,?,?,?)",
                BeanPropertyRowMapper.newInstance(TicketDTO.class),
                start == null ? null : Date.valueOf(start),
                end   == null ? null : Date.valueOf(end),
                status, priority);
    }
}





package com.example.productsupport.service;

import com.example.productsupport.dto.TicketDTO;
import com.example.productsupport.repository.TicketRepository;
import jakarta.servlet.http.HttpSession;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Service
public class TicketService {

    private final TicketRepository repo;
    private final HttpSession session;

    public TicketService(TicketRepository repo, HttpSession session) {
        this.repo = repo;
        this.session = session;
    }

    public String currentUser() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        return auth != null ? auth.getName() : "anonymous";
    }

    public boolean isAdmin() {
        return currentUser().contains("admin");   // simple demo rule
    }

    public List<Map<String, Object>> dropdown(String type) {
        return repo.getDropdown(type);
    }

    /* ---------- CREATE ---------- */
    public void create(TicketDTO t, MultipartFile file) throws IOException {
        t.setCreatedBy(currentUser());
        t.setCreatedDate(LocalDateTime.now());
        t.setStatus("New");
        if (file != null && !file.isEmpty()) t.setAttachment(file.getBytes());

        Long id = repo.insertTicket(t);
        t.setId(id);
        session.setAttribute("alert", "Ticket #" + id + " created.");
    }

    /* ---------- UPDATE ---------- */
    public void update(TicketDTO t) {
        TicketDTO old = repo.byId(t.getId());
        repo.updateTicket(t);

        if (!old.getStatus().equals(t.getStatus())) {
            String msg = switch (t.getStatus()) {
                case "Assigned"     -> "Ticket #" + t.getId() + " assigned to " + t.getAssignedTo();
                case "Resolved"     -> { t.setResolvedDate(LocalDateTime.now()); repo.updateTicket(t);
                                          yield "Ticket #" + t.getId() + " resolved."; }
                case "Closed"       -> { t.setClosedDate(LocalDateTime.now()); repo.updateTicket(t);
                                          yield "Ticket #" + t.getId() + " closed."; }
                default             -> null;
            };
            if (msg != null) session.setAttribute("alert", msg);
        }
    }

    public List<TicketDTO> recent()          { return repo.recent(); }
    public List<TicketDTO> myTickets()       { return repo.myTickets(currentUser()); }
    public TicketDTO byId(Long id)           { return repo.byId(id); }
    public List<TicketDTO> filtered(String s, String e,
                                   String st, String p) { return repo.filtered(s,e,st,p); }
}


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Home</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f9f9f9; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav a { padding: 10px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .nav a.active { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007bff; color: white; }
        .btn { padding: 5px 10px; background: #28a745; color: white; border-radius: 3px; text-decoration: none; }
    </style>
    <script src="/js/app.js"></script>
    <script>
        async function loadRecent() {
            const tickets = await get('/api/recent');
            const isAdmin = await get('/api/isAdmin');
            const tbody = document.querySelector('#recent tbody');
            tbody.innerHTML = '';
            tickets.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id}</td>
                    <td>${t.subject}</td>
                    <td>${t.status}</td>
                    <td>${t.createdBy}</td>
                    ${isAdmin ? `<td><a href="/ticketForm.html?id=${t.id}" class="btn">Edit</a></td>` : ''}
                `;
                tbody.appendChild(tr);
            });
        }
        window.onload = loadRecent;
    </script>
</head>
<body data-alert="">
    <div class="nav">
        <a href="/home.html" class="active">Home</a>
        <a href="/menu.html">Menu</a>
        <a href="/reports.html">Reports</a>
        <a href="/logout" style="margin-left: auto;">Logout</a>
    </div>
    <h2>Recent Tickets</h2>
    <table id="recent">
        <thead><tr><th>ID</th><th>Subject</th><th>Status</th><th>Created By</th><th>Action</th></tr></thead>
        <tbody></tbody>
    </table>
</body>
</html>





<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Menu</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f9f9f9; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav a { padding: 10px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .nav a.active { background: #0056b3; }
        form { background: white; padding: 20px; border: 1px solid #ddd; max-width: 500px; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-top: 15px; background: #007bff; color: white; padding: 10px; border: none; border-radius: 4px; }
        table { width: 100%; margin-top: 30px; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #007bff; color: white; }
    </style>
    <script src="/js/app.js"></script>
    <script>
        async function loadMyTickets() {
            const tickets = await get('/api/myTickets');
            const tbody = document.querySelector('#myTickets tbody');
            tbody.innerHTML = '';
            tickets.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${t.id}</td><td>${t.subject}</td><td>${t.status}</td>`;
                tbody.appendChild(tr);
            });
        }

        window.onload = async () => {
            await loadDropdown('priority', 'priority');
            await loadDropdown('category', 'category');
            loadMyTickets();
        };
    </script>
</head>
<body>
    <div class="nav">
        <a href="/home.html">Home</a>
        <a href="/menu.html" class="active">Menu</a>
        <a href="/reports.html">Reports</a>
        <a href="/logout" style="margin-left: auto;">Logout</a>
    </div>

    <h2>Submit Request</h2>
    <form id="ticketForm" enctype="multipart/form-data">
        <label>Subject</label>
        <input name="subject" required/>

        <label>Description</label>
        <textarea name="description"></textarea>

        <label>Priority</label>
        <select id="priority" name="priority" required></select>

        <label>Category</label>
        <select id="category" name="category" required></select>

        <label>Attachment</label>
        <input type="file" name="attachment"/>

        <button type="submit">Submit</button>
    </form>

    <h2>My Tickets</h2>
    <table id="myTickets">
        <thead><tr><th>ID</th><th>Subject</th><th>Status</th></tr></thead>
        <tbody></tbody>
    </table>

    <script>
        document.getElementById('ticketForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            await post('/api/submit', formData);
            window.location.reload();
        };
    </script>
</body>
</html>




// Global alert handler
window.addEventListener('load', () => {
    const alertMsg = document.body.dataset.alert;
    if (alertMsg) {
        alert(alertMsg);
        delete document.body.dataset.alert;
    }
});

// Fetch JSON helper
async function get(url) {
    const res = await fetch(url);
    return await res.json();
}

async function post(url, data) {
    const res = await fetch(url, {
        method: 'POST',
        body: data
    });
    return await res.text();
}

// Load dropdown
async function loadDropdown(selectId, type) {
    const data = await get(`/api/dropdown/${type}`);
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.value;
        opt.textContent = item.label;
        select.appendChild(opt);
    });
}

// Show alert from session
function showAlert() {
    fetch('/api/user').then(() => {
        // Alert is set in session by backend, shown on page load
    });
}





package com.example.productsupport.controller;

import com.example.productsupport.dto.TicketDTO;
import com.example.productsupport.service.TicketService;
import jakarta.servlet.http.HttpSession;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.http.*;
import org.springframework.security.core.Authentication;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.List;

@RestController
@RequestMapping("/api")
public class ApiController {

    private final TicketService service;
    private final HttpSession session;

    public ApiController(TicketService service, HttpSession session) {
        this.service = service;
        this.session = session;
    }

    private void alert(String msg) {
        session.setAttribute("alert", msg);
    }

    @GetMapping("/user")
    public String user(Authentication auth) {
        return auth.getName();
    }

    @GetMapping("/isAdmin")
    public boolean isAdmin(Authentication auth) {
        return auth.getAuthorities().stream()
                .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
    }

    @GetMapping("/recent")
    public List<TicketDTO> recent() {
        return service.recent();
    }

    @GetMapping("/myTickets")
    public List<TicketDTO> myTickets(Authentication auth) {
        return service.myTickets();
    }

    @GetMapping("/dropdown/{type}")
    public List<java.util.Map<String, Object>> dropdown(@PathVariable String type) {
        return service.dropdown(type);
    }

    @PostMapping("/submit")
    public ResponseEntity<String> submit(
            @ModelAttribute TicketDTO ticket,
            @RequestParam(required = false) MultipartFile attachment) throws IOException {
        service.create(ticket, attachment);
        alert("Ticket #" + ticket.getId() + " created.");
        return ResponseEntity.ok("success");
    }

    @GetMapping("/ticket/{id}")
    public TicketDTO get(@PathVariable Long id) {
        return service.byId(id);
    }

    @PostMapping("/update")
    public ResponseEntity<String> update(@ModelAttribute TicketDTO ticket) {
        service.update(ticket);
        return ResponseEntity.ok("updated");
    }

    @GetMapping("/filtered")
    public List<TicketDTO> filtered(
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String priority) {
        return service.filtered(startDate, endDate, status, priority);
    }

    @GetMapping("/export")
    public ResponseEntity<byte[]> export(
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String priority) throws IOException {

        List<TicketDTO> list = service.filtered(startDate, endDate, status, priority);
        Workbook wb = new XSSFWorkbook();
        Sheet sh = wb.createSheet("Tickets");
        Row hdr = sh.createRow(0);
        hdr.createCell(0).setCellValue("ID");
        hdr.createCell(1).setCellValue("Subject");
        hdr.createCell(2).setCellValue("Status");
        hdr.createCell(3).setCellValue("Priority");
        hdr.createCell(4).setCellValue("Created By");

        int r = 1;
        for (TicketDTO t : list) {
            Row row = sh.createRow(r++);
            row.createCell(0).setCellValue(t.getId());
            row.createCell(1).setCellValue(t.getSubject());
            row.createCell(2).setCellValue(t.getStatus());
            row.createCell(3).setCellValue(t.getPriority());
            row.createCell(4).setCellValue(t.getCreatedBy());
        }

        ByteArrayOutputStream out = new ByteArrayOutputStream();
        wb.write(out);
        wb.close();

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=tickets.xlsx")
                .contentType(MediaType.APPLICATION_OCTET_STREAM)
                .body(out.toByteArray());
    }
}



package com.example.productsupport.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class PageController {

    @GetMapping({"/", "/home.html"})
    public String home() { return "forward:/static/home.html"; }

    @GetMapping("/menu.html")
    public String menu() { return "forward:/static/menu.html"; }

    @GetMapping("/reports.html")
    public String reports() { return "forward:/static/reports.html"; }

    @GetMapping("/ticketForm.html")
    public String ticketForm() { return "forward:/static/ticketForm.html"; }
}




package com.example.productsupport.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
public class SimpleSecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/h2-console/**", "/api/**", "/static/**", "/js/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .defaultSuccessUrl("/home.html", true)
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login")
                .permitAll()
            )
            .csrf(csrf -> csrf.ignoringRequestMatchers("/h2-console/**"))
            .headers(headers -> headers.frameOptions().sameOrigin());
        return http.build();
    }

    @Bean
    public UserDetailsService users() {
        UserDetails user = User.withUsername("user")
                .password("{noop}user")
                .roles("USER")
                .build();
        UserDetails admin = User.withUsername("admin")
                .password("{noop}admin")
                .roles("ADMIN")
                .build();
        return new InMemoryUserDetailsManager(user, admin);
    }
}






<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Ticket Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; max-width: 600px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { height: 100px; }
        button { margin-top: 20px; background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .back-btn { background: #6c757d; margin-left: 10px; }
        .back-btn:hover { background: #5a6268; }
    </style>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.onload = function() {
            var msg = /*[[${alert}]]*/ null;
            if (msg) alert(msg);
        };
        /*]]>*/
    </script>
</head>
<body>
    <div class="container">
        <h2>Tracker Form – Ticket #<span th:text="${ticket.id}"></span></h2>
        <form th:action="@{/updateTicket}" th:object="${ticket}" method="post">
            <input type="hidden" th:field="*{id}"/>

            <label>Subject</label>
            <input th:field="*{subject}" readonly/>

            <label>Description</label>
            <textarea th:field="*{description}" readonly></textarea>

            <label>Assign Engineer</label>
            <select th:field="*{assignedTo}">
                <option th:each="e : ${engineers}" th:value="${e.value}" th:text="${e.label}"></option>
            </select>

            <label>Status</label>
            <select th:field="*{status}">
                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
            </select>

            <button type="submit">Update</button>
            <a th:href="@{/home}" class="back-btn" style="padding: 10px 20px; display: inline-block; color: white; text-decoration: none;">Cancel</a>
        </form>
    </div>
</body>
</html>




<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Reports</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .nav-tabs { display: flex; list-style: none; padding: 0; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        .nav-tabs li { margin-right: 5px; }
        .nav-tabs a { display: block; padding: 10px 15px; background: #e9ecef; text-decoration: none; color: #333; }
        .nav-tabs a.active, .nav-tabs a:hover { background: #007bff; color: white; }
        .filter-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { grid-column: span 2; background: #007bff; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #007bff; color: white; }
        .export-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; }
        .export-btn:hover { background: #218838; }
    </style>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.onload = function() {
            var msg = /*[[${alert}]]*/ null;
            if (msg) alert(msg);
        };
        /*]]>*/
    </script>
</head>
<body>
    <ul class="nav-tabs">
        <li><a href="/home">Home</a></li>
        <li><a href="/menu">Menu</a></li>
        <li><a class="active" href="/reports">Reports</a></li>
        <li style="margin-left: auto;"><a href="/logout">Logout</a></li>
    </ul>

    <h2>Filter Tickets</h2>
    <form th:action="@{/filterReports}" method="post" class="filter-form">
        <div>
            <label>Start Date</label>
            <input type="date" name="startDate"/>
        </div>
        <div>
            <label>End Date</label>
            <input type="date" name="endDate"/>
        </div>
        <div>
            <label>Status</label>
            <select name="status">
                <option value="">All</option>
                <option th:each="s : ${statuses}" th:value="${s}" th:text="${s}"></option>
            </select>
        </div>
        <div>
            <label>Priority</label>
            <select name="priority">
                <option value="">All</option>
                <option th:each="o : ${priorities}" th:value="${o.value}" th:text="${o.label}"></option>
            </select>
        </div>
        <button type="submit">Apply Filter</button>
    </form>

    <th:block th:if="${tickets != null}">
        <h3>Results</h3>
        <table>
            <thead>
                <tr><th>ID</th><th>Subject</th><th>Status</th><th>Priority</th><th>Created By</th></tr>
            </thead>
            <tbody>
                <tr th:each="t : ${tickets}">
                    <td th:text="${t.id}"></td>
                    <td th:text="${t.subject}"></td>
                    <td th:text="${t.status}"></td>
                    <td th:text="${t.priority}"></td>
                    <td th:text="${t.createdBy}"></td>
                </tr>
            </tbody>
        </table>
        <a th:href="@{/exportReports(startDate=${param.startDate[0]},endDate=${param.endDate[0]},status=${param.status[0]},priority=${param.priority[0]})}"
           class="export-btn">Export to Excel</a>
    </th:block>
</body>
</html>



-- Table
CREATE TABLE IF NOT EXISTS tickets (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    subject VARCHAR(255) NOT NULL,
    description CLOB,
    priority VARCHAR(50),
    category VARCHAR(50),
    status VARCHAR(50) DEFAULT 'New',
    created_by VARCHAR(255) NOT NULL,
    created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_to VARCHAR(255),
    resolved_date TIMESTAMP,
    closed_date TIMESTAMP,
    attachment BLOB
);

-- Dropdown values
CREATE ALIAS IF NOT EXISTS get_dropdown_values AS $$
import java.sql.*;
@CODE
ResultSet get_dropdown_values(Connection conn, String type) throws SQLException {
    String sql = """
        SELECT value, label FROM (
            VALUES
            ('High','High'), ('Medium','Medium'), ('Low','Low')
        ) AS t(value,label) WHERE ? = 'priority'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('Bug','Bug'), ('Feature','Feature'), ('Support','Support')
        ) AS t(value,label) WHERE ? = 'category'
        UNION ALL
        SELECT value, label FROM (
            VALUES
            ('engineer1','Engineer 1'),
            ('engineer2','Engineer 2')
        ) AS t(value,label) WHERE ? = 'engineer';
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, type);
    ps.setString(2, type);
    ps.setString(3, type);
    return ps.executeQuery();
}
$$;

-- Insert ticket
CREATE ALIAS IF NOT EXISTS insert_ticket AS $$
import java.sql.*;
@CODE
long insert_ticket(Connection conn,
                  String p_subject, String p_description,
                  String p_priority, String p_category,
                  String p_created_by, byte[] p_attachment) throws SQLException {
    String sql = "INSERT INTO tickets(subject,description,priority,category,created_by,attachment) VALUES(?,?,?,?,?,?)";
    PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
    ps.setString(1, p_subject);
    ps.setString(2, p_description);
    ps.setString(3, p_priority);
    ps.setString(4, p_category);
    ps.setString(5, p_created_by);
    ps.setObject(6, p_attachment);
    ps.executeUpdate();
    ResultSet rs = ps.getGeneratedKeys();
    rs.next();
    return rs.getLong(1);
}
$$;

-- Update ticket
CREATE ALIAS IF NOT EXISTS update_ticket AS $$
import java.sql.*;
@CODE
void update_ticket(Connection conn,
                   long p_id,
                   String p_assigned_to,
                   String p_status,
                   Timestamp p_resolved_date,
                   Timestamp p_closed_date) throws SQLException {
    String sql = """
        UPDATE tickets SET
            assigned_to = COALESCE(?, assigned_to),
            status      = COALESCE(?, status),
            resolved_date = COALESCE(?, resolved_date),
            closed_date   = COALESCE(?, closed_date)
        WHERE id = ?
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_assigned_to);
    ps.setString(2, p_status);
    ps.setTimestamp(3, p_resolved_date);
    ps.setTimestamp(4, p_closed_date);
    ps.setLong(5, p_id);
    ps.executeUpdate();
}
$$;

-- Recent tickets
CREATE ALIAS IF NOT EXISTS get_recent_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_recent_tickets(Connection conn) throws SQLException {
    return conn.createStatement().executeQuery(
        "SELECT * FROM tickets WHERE created_date >= CURRENT_DATE - INTERVAL '7' DAY ORDER BY created_date DESC"
    );
}
$$;

-- My tickets
CREATE ALIAS IF NOT EXISTS get_user_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_user_tickets(Connection conn, String p_created_by) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE created_by = ? ORDER BY created_date DESC";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setString(1, p_created_by);
    return ps.executeQuery();
}
$$;

-- Ticket by ID
CREATE ALIAS IF NOT EXISTS get_ticket_by_id AS $$
import java.sql.*;
@CODE
ResultSet get_ticket_by_id(Connection conn, long p_id) throws SQLException {
    String sql = "SELECT * FROM tickets WHERE id = ?";
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setLong(1, p_id);
    return ps.executeQuery();
}
$$;

-- Filtered tickets
CREATE ALIAS IF NOT EXISTS get_filtered_tickets AS $$
import java.sql.*;
@CODE
ResultSet get_filtered_tickets(Connection conn,
                               Date p_start, Date p_end,
                               String p_status, String p_priority) throws SQLException {
    String sql = """
        SELECT * FROM tickets
        WHERE (CAST(created_date AS DATE) BETWEEN ? AND ? OR (? IS NULL AND ? IS NULL))
          AND (status = ? OR ? IS NULL)
          AND (priority = ? OR ? IS NULL)
        ORDER BY created_date DESC
        """;
    PreparedStatement ps = conn.prepareStatement(sql);
    ps.setDate(1, p_start);
    ps.setDate(2, p_end);
    ps.setDate(3, p_start);
    ps.setDate(4, p_end);
    ps.setString(5, p_status);
    ps.setString(6, p_status);
    ps.setString(7, p_priority);
    ps.setString(8, p_priority);
    return ps.executeQuery();
}
$$;





<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Ticket Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .container { background: white; padding: 25px; border: 1px solid #ddd; border-radius: 5px; max-width: 600px; }
        h2 { margin-top: 0; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea { height: 100px; }
        .readonly { background: #f0f0f0; }
        button { margin-top: 20px; background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .back-btn { background: #6c757d; margin-left: 10px; }
        .back-btn:hover { background: #5a6268; }
    </style>
    <script src="/js/app.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = urlParams.get('id');

        async function loadTicket() {
            if (!ticketId) {
                alert("No ticket ID provided.");
                window.location.href = "/home.html";
                return;
            }

            const ticket = await get(`/api/ticket/${ticketId}`);
            if (!ticket) {
                alert("Ticket not found.");
                window.location.href = "/home.html";
                return;
            }

            document.getElementById('ticketId').textContent = ticket.id;
            document.getElementById('subject').value = ticket.subject;
            document.getElementById('description').value = ticket.description;
            document.getElementById('assignedTo').value = ticket.assignedTo || '';
            document.getElementById('status').value = ticket.status;

            // Load engineers
            const engineers = await get('/api/dropdown/engineer');
            const select = document.getElementById('assignedTo');
            engineers.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.value; opt.textContent = e.label;
                if (e.value === ticket.assignedTo) opt.selected = true;
                select.appendChild(opt);
            });
        }

        async function saveTicket() {
            const formData = new FormData();
            formData.append('id', ticketId);
            formData.append('assignedTo', document.getElementById('assignedTo').value);
            formData.append('status', document.getElementById('status').value);

            await post('/api/update', formData);
            window.location.href = "/home.html";
        }

        window.onload = loadTicket;
    </script>
</head>
<body>
    <div class="container">
        <h2>Ticket #<span id="ticketId"></span></h2>

        <label>Subject</label>
        <input id="subject" class="readonly" readonly/>

        <label>Description</label>
        <textarea id="description" class="readonly" readonly></textarea>

        <label>Assign Engineer</label>
        <select id="assignedTo"></select>

        <label>Status</label>
        <select id="status">
            <option value="Assigned">Assigned</option>
            <option value="In-Progress">In-Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
        </select>

        <button onclick="saveTicket()">Update Ticket</button>
        <a href="/home.html" class="back-btn" style="padding: 10px 20px; display: inline-block; color: white; text-decoration: none;">Cancel</a>
    </div>
</body>
</html>






<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <title>Reports</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav a { padding: 10px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .nav a.active { background: #0056b3; }
        .filter-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        label { font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { grid-column: span 2; background: #007bff; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #007bff; color: white; }
        .export-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; }
        .export-btn:hover { background: #218838; }
    </style>
    <script src="/js/app.js"></script>
    <script>
        async function loadDropdowns() {
            await loadDropdown('status', 'status');
            await loadDropdown('priority', 'priority');
        }

        async function applyFilter() {
            const params = new URLSearchParams({
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('status').value,
                priority: document.getElementById('priority').value
            });

            const tickets = await get(`/api/filtered?${params}`);
            const tbody = document.querySelector('#results tbody');
            tbody.innerHTML = '';
            tickets.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${t.id}</td>
                    <td>${t.subject}</td>
                    <td>${t.status}</td>
                    <td>${t.priority}</td>
                    <td>${t.createdBy}</td>
                `;
                tbody.appendChild(tr);
            });

            // Show export button only if results exist
            const exportBtn = document.getElementById('exportBtn');
            exportBtn.style.display = tickets.length > 0 ? 'inline-block' : 'none';
            exportBtn.href = `/api/export?${params}`;
        }

        window.onload = async () => {
            await loadDropdowns();

            // Pre-fill status dropdown
            const statusSelect = document.getElementById('status');
            const statuses = ['New', 'Assigned', 'In-Progress', 'Resolved', 'Closed'];
            statusSelect.innerHTML = '<option value="">All</option>';
            statuses.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                statusSelect.appendChild(opt);
            });

            // Load initial data (all tickets)
            applyFilter();
        };
    </script>
</head>
<body>
    <div class="nav">
        <a href="/home.html">Home</a>
        <a href="/menu.html">Menu</a>
        <a href="/reports.html" class="active">Reports</a>
        <a href="/logout" style="margin-left: auto;">Logout</a>
    </div>

    <h2>Filter Tickets</h2>
    <form class="filter-form" onsubmit="event.preventDefault(); applyFilter();">
        <div>
            <label>Start Date</label>
            <input type="date" id="startDate"/>
        </div>
        <div>
            <label>End Date</label>
            <input type="date" id="endDate"/>
        </div>
        <div>
            <label>Status</label>
            <select id="status"></select>
        </div>
        <div>
            <label>Priority</label>
            <select id="priority"></select>
        </div>
        <button type="submit">Apply Filter</button>
    </form>

    <h3 id="resultsHeader" style="display:none;">Results</h3>
    <table id="results" style="display:none;">
        <thead>
            <tr><th>ID</th><th>Subject</th><th>Status</th><th>Priority</th><th>Created By</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <a id="exportBtn" class="export-btn" style="display:none;" download>Export to Excel</a>

    <script>
        // Show table only when data is loaded
        const originalApplyFilter = applyFilter;
        applyFilter = async () => {
            document.getElementById('results').style.display = 'table';
            document.getElementById('resultsHeader').style.display = 'block';
            await originalApplyFilter();
        };
    </script>
</body>
</html>
